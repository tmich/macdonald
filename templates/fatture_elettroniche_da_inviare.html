{% extends "layout.html" %}
{% block actions %}
    <div>
        <a href="{{ url_for('main') }}" class="btn btn-default">&laquo; Indietro</a>
        <a href="#" onclick="submitForm();" class="pull-right btn btn-success {{'disabled' if fatture_da_inviare|count == 0 else '' }}">
            <span class="glyphicon glyphicon-euro"></span> Trasmetti ad AGYO <span class="badge">{{fatture_da_inviare|count}}</span></a>
    </div>
{% endblock %}
{% block body %}
  <h3 class="page-header">Fatture da trasmettere ad AGYO</h3>
  
  {% if errors|length > 0 %}
	  <div id="errors">
		<ul>
		{% for e in errors %}
			<li>{{ e }}</li>
		{% endfor %}
		</ul>
	  </div>
  {% endif %}
  
  <form id="form1" action="{{url_for('trasmetti_fatture_elettroniche', next=request.url_rule)}}" method="POST">
  </form>
  
  <div class="table-responsive">
    {% if cnt > 0 %}
      <table class="table table-striped">
	<tr>
	  <th style="width: 10%;">Fatt. n</th>
	  <th style="width: 10%;">Data</th>
	  <th style="width: 5%;">Scontr.</th>
	  <th style="width: 50%;">Cliente</th>
	  <th style="width: 15%;">Importo</th>
	  <th style="width: 5%;">&nbsp;</th>
	  <th style="width: 5%;">&nbsp;</th>
	</tr>
	{% for inv in fatture_da_inviare %}
	  <tr>
	    <td>{{inv.fattura.num}}</td>
	    <td>{{inv.fattura.data|dt('%d/%m/%Y')}}</td>
	    <td>{{inv.fattura.scontrini}}</td>
	    <td>{{inv.fattura.cliente.ragsoc}}</td>
	    <td>{{'%0.2f' % inv.fattura.totale()|float}}</td>
		<td><a href="#" id="btnxml-{{inv.id}}" class="btn btn-sm btn-default btn-xml" 
			onclick="return visualizza_xml({{inv.id}});" title="Visualizza XML">
			<span class="glyphicon glyphicon-eye-open"></span></a></td>
	    <td style="text-align:right;"><a title="Annulla invio" onclick="return confirm('Sei sicuro di voler annullare l\'invio della fattura?');" 
				class="btn btn-sm btn-danger"
				href="{{url_for('annulla_invio_fattura_elettronica', id=inv.id)}}">Annulla</a></td>
	  </tr>
	{% endfor %}
      </table>
    {% else %}
      <p>Nessuna fattura da inviare ad AGYO</p>
    {% endif %}
  </div>
  
 <!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Visualizzazione XML</h4>
			</div>
			<div class="modal-body">
				<textarea readonly="readonly" id="modal-textarea" style="border:none;width: 100%; height: 400px;">
				</textarea>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Chiudi</button>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<script type=text/javascript>

$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

function visualizza_xml(id_invio) {
	$.get( $SCRIPT_ROOT + "/xml_fattura/" + id_invio, function( data ) {
		$( "#modal-textarea" ).val(data);
		$("#myModal").modal();
	});
}

function submitForm() {
	if(confirm('Inviare le fatture ad AGYO?')) {
		$("#form1").submit();
	}
}
</script>
{% endblock %}